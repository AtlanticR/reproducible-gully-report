# TABLES {#sec:tables}

```{r table-setup, include=FALSE, echo=FALSE}
options(tinytex.verbose = TRUE)

library(oce)
library(stringr)
library(kableExtra)
library(lubridate)
library(dplyr)
library(tibble)

```


<!-- \begin{landscapepage} -->

(ref:table1) Summary of CTD profiles collected at the four AZMP fixed stations in the Gully (SG_23, SG_28, GULD_03, and GULD_04) between 1999 to 2018. Survey, month of sampling, station coordinates in decimal degrees (DD), maximum depth of the CTD package, and the date of collection/start time in UTC is shown. Only profiles collected in April (37 profiles; representative of spring) and September-October (45 profiles, representative of fall) are included in the analyses presented in this report.

```{r table1, results="asis", include=TRUE, echo=FALSE}

# Load the CTD data acquired at the four monitoring stations.
load("data/monitoringSitesAllCtd.RData")
load("data/monitoringSitesAllCtdPrograms.RData")

# Load the CTD data acquired at the four monitoring stations (only used to 
# produce the CTD table to identify casts for analysis.
# load("data/monitoringSitesCtdForAnalysis.RData")
# load("data/monitoringSitesCtdForAnalysisPrograms.RData")

# Data sets.
dsets <- c("guld03_ctd", "guld04_ctd", "sg23_ctd", "sg28_ctd")

# Modify the station name metadata attribute to be the appropriate Gully
# monitoring station name in each ctd object of each data set.
for (j in 1:4) {
  ds <- dsets[j]
  dset <- eval(parse(text=paste0(ds)))
  nctds <- length(dset)
  bits <- unlist(str_split(ds, "_"))
  sName <- bits[1]
  # Note that underscore characters in latex output must be escaped.
  if (sName == "guld03") stn <- "GULD\\_03"
  else if (sName == "guld04") stn <- "GULD\\_04"
  else if (sName == "sg23") stn <- "SG\\_23"
  else if (sName == "sg28") stn <- "SG\\_28"
  for (z in 1:nctds) {
    dset[[z]]@metadata$stationName <- stn
  }
  eval(parse(text=paste0(ds, " <- dset")))
}

# Combine the four lists of ctd objects into a new list so that the table that
# will to be produced will have all of the data listed by cruise in
# chronological order.
gullyCTD <- c(guld03_ctd, guld04_ctd, sg23_ctd, sg28_ctd)
gullyCTDprograms <- c(guld03_programs, guld04_programs, sg23_programs, sg28_programs)

# Get all of the start times for all Gully CTD objects.
startTime <- as.character(as.POSIXct(unlist(lapply(gullyCTD, function(k) k[['startTime']])),
                                     origin = '1970-01-01',
                                     tz = 'UTC'))

# Get the sorted indices of the list so that the list can be sorted in
# chronological order.
ix <- order(startTime)

# Put the CTD objects into chronological order.
gullyCTD <- gullyCTD[ix]
gullyCTDprograms <- gullyCTDprograms[ix]

# Get the metadata required to build the table for the report.
cruiseNumber <- unlist(lapply(gullyCTD, function(k) k@metadata$cruiseNumber))
stationName <- unlist(lapply(gullyCTD, function(k) k@metadata$stationName))
Event <- unlist(lapply(gullyCTD, function(k) k@metadata$eventNumber))
Survey <- unlist(lapply(gullyCTDprograms, function(k) k))
Longitude <- unlist(lapply(gullyCTD, function(k) k[['longitude']][1]))
Latitude <- unlist(lapply(gullyCTD, function(k) k[['latitude']][1]))
Maximum_Depth <- unlist(lapply(gullyCTD, function(k) k[['depthMax']]))
Start_Date_Time <- startTime[ix]
mon <- month(startTime, label = TRUE, abbr = FALSE)

# ucn <- unique(cruiseNumber)
# lucn <- unlist(lapply(ucn, function(k) length(which(cruiseNumber == k))))

# Fix the station strings by replacing the "\\" with an empty string "". Since
# backslash is the escape sequence character you have to escape each backslash
# in the replace call.
Station <- str_replace(stationName, "\\\\", "")

#for ordering by year and cruise number
# note that this might not be the best if multiple charters for once year
# e.g. could have been an issue if both the COR and EN had event num 001
# but they're different so I got lucky.
Cruise <- str_extract(string = cruiseNumber, pattern = '[0-9]{7}')

# cruiseYear <- substr(x = cruise, start = 1, stop = 4)
# cruiseNum <- substr(x = cruise, start = 5, stop = 7)

header <- c('Cruise', 'Station', 'Event', 'Survey', 'Month', 'Longitude (DD)', 
            'Latitude (DD)', 'Maximum Depth (m)', 'Data/start time (UTC)')

#format(longitude, digits = 6)
# format(latitude, digits = 6)

ctable <- tibble(Cruise, Station, Event, Survey, mon, Latitude, 
                 Longitude, Maximum_Depth, Start_Date_Time, row.names = NULL)

colnames(ctable) <- header

# kbl(ctable,
#     format = 'latex',
#     align = 'cccccccccc',
#     caption = '(ref:table1)',
#     longtable = TRUE,
#     col.names = header
#     ) %>%
# kable_styling(full_width = FALSE,
#               font_size = 11,
#               bootstrap_options = c("bordered"),
#               latex_options = c("repeat_header"),
#               repeat_header_method = "replace") %>%
# row_spec(row = 0, bold = TRUE) %>%
# column_spec(1, width = "7em", border_left = TRUE) %>%
# column_spec(2, width = "4em") %>%
# column_spec(3, width = "6em") %>%
# column_spec(4, width = "6em") %>%
# column_spec(5, width = "6em") %>%
# column_spec(6, width = "6em") %>%
# column_spec(7, width = "6em") %>%
# column_spec(8, width = "6em") %>%
# column_spec(9, width = "6em") %>%
# column_spec(10, width = "6em", border_right = TRUE) %>%
# landscape()

csasdown::csas_table(ctable,
                     format = "latex",
                     font_size = 11)
                     # repeat_header = TRUE)

# %>%
# kableExtra::row_spec(row = 0, bold = TRUE) %>%
# kableExtra::column_spec(1, width = "7em", border_left = TRUE) %>%
# kableExtra::column_spec(2, width = "4em") %>%
# kableExtra::column_spec(3, width = "6em") %>%
# kableExtra::column_spec(4, width = "6em") %>%
# kableExtra::column_spec(5, width = "6em") %>%
# kableExtra::column_spec(6, width = "6em") %>%
# kableExtra::column_spec(7, width = "6em") %>%
# kableExtra::column_spec(8, width = "6em") %>%
# kableExtra::column_spec(9, width = "6em") %>%
# kableExtra::column_spec(10, width = "11em", border_right = TRUE)

```
<!-- \end{landscapepage} -->

\clearpage
