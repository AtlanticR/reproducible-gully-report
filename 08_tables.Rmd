# TABLES {#sec:tables}

```{r table-setup, include=FALSE, echo=FALSE}
options(tinytex.verbose = TRUE)

library(oce)
library(stringr)
library(kableExtra)
library(lubridate)
library(dplyr)
library(tibble)

```

\begin{landscapepage}


```{r table1, results="asis", include=TRUE, echo=FALSE}

# Load the CTD data acquired at the four monitoring stations.
load("data/monitoringSitesAllCtd.RData")
load("data/monitoringSitesAllCtdPrograms.RData")

# Load the CTD data acquired at the four monitoring stations (only used to 
# produce the CTD table to identify casts for analysis.
# load("data/monitoringSitesCtdForAnalysis.RData")
# load("data/monitoringSitesCtdForAnalysisPrograms.RData")

# Data sets.
dsets <- c("guld03_ctd", "guld04_ctd", "sg23_ctd", "sg28_ctd")

# Modify the station name metadata attribute to be the appropriate Gully
# monitoring station name in each ctd object of each data set.
for (j in 1:4) {
  ds <- dsets[j]
  dset <- eval(parse(text=paste0(ds)))
  nctds <- length(dset)
  bits <- unlist(str_split(ds, "_"))
  sName <- bits[1]
  # Note that underscore characters in latex output must be escaped.
  if (sName == "guld03") stn <- "GULD\\_03"
  else if (sName == "guld04") stn <- "GULD\\_04"
  else if (sName == "sg23") stn <- "SG\\_23"
  else if (sName == "sg28") stn <- "SG\\_28"
  for (z in 1:nctds) {
    dset[[z]]@metadata$stationName <- stn
  }
  eval(parse(text=paste0(ds, " <- dset")))
}

# Combine the four lists of ctd objects into a new list so that the table that
# will to be produced will have all of the data listed by cruise in
# chronological order.
gullyCTD <- c(guld03_ctd, guld04_ctd, sg23_ctd, sg28_ctd)
gullyCTDprograms <- c(guld03_programs, guld04_programs, sg23_programs, sg28_programs)

# Get all of the start times for all Gully CTD objects.
startTime <- as.character(as.POSIXct(unlist(lapply(gullyCTD, function(k) k[['startTime']])),
                                     origin = '1970-01-01',
                                     tz = 'UTC'))

# Get the sorted indices of the list so that the list can be sorted in
# chronological order.
ix <- order(startTime)

# Put the CTD objects into chronological order.
gullyCTD <- gullyCTD[ix]
gullyCTDprograms <- gullyCTDprograms[ix]

# Get the metadata required to build the table for the report.
cruiseNumber <- unlist(lapply(gullyCTD, function(k) k@metadata$cruiseNumber))
stationName <- unlist(lapply(gullyCTD, function(k) k@metadata$stationName))
Event <- unlist(lapply(gullyCTD, function(k) k@metadata$eventNumber))
Survey <- unlist(lapply(gullyCTDprograms, function(k) k))
Longitude <- unlist(lapply(gullyCTD, function(k) k[['longitude']][1]))
Latitude <- unlist(lapply(gullyCTD, function(k) k[['latitude']][1]))
Maximum_Depth <- unlist(lapply(gullyCTD, function(k) k[['depthMax']]))
Start_Date_Time <- startTime[ix]

# Get the name of the month  when the profile occurred.  Change the output to a
# character array from "ordered" "factor".
mon <- month(startTime, label = TRUE, abbr = FALSE)
mon <- as.character(mon)

# Change the maximum depth from a number to a string without any decimals.
Maximum_Depth <- as.character(round(Maximum_Depth,0))

# Fix the station strings by replacing the "\\" with an empty string "". Since
# backslash is the escape sequence character you have to escape each backslash
# in the replace call.  This line is used if calling kable() directly.  It is 
# commented out if using csas_table() instead.
# Station <- str_replace(stationName, "\\\\", "")

#for ordering by year and cruise number
# note that this might not be the best if multiple charters for one year
# e.g. could have been an issue if both the COR and EN had event number 001
# but they're different so I got lucky.
Cruise <- str_extract(string = cruiseNumber, pattern = '[0-9]*$')

header <- c("Cruise", "Station", "Event", "Survey", "Month", "Longitude (DD)", 
            "Latitude (DD)", "Maximum Depth (m)", "Date/Start Time (UTC)")

ctable <- tibble(Cruise, stationName, Event, Survey, mon, Latitude, Longitude, Maximum_Depth, Start_Date_Time)

colnames(ctable) <- header

csasdown::csas_table(ctable,
                     format = "latex",
                     font_size = 10,
                     align = rep("c", 9),
                     repeat_header = TRUE,
                     caption = "Summary of CTD profiles collected at the four AZMP fixed stations in the Gully (SG\\_23, SG\\_28, GULD\\_03, and GULD\\_04) between 1999 to 2018. Survey, month of sampling, station coordinates in decimal degrees (DD), maximum depth of the CTD package, and the date of collection/start time in UTC is shown. Only profiles collected in April (37 profiles; representative of spring) and September-October (45 profiles, representative of fall) are included in the analyses presented in this report."
                     )
```
\end{landscapepage}

\clearpage

```{r table2, results="asis", include=TRUE, echo=FALSE}

seasons <- c(rep("Spring", 4), rep("Fall", 4))
stations <- c("GULD\\_03", "GULD\\_04", "SG\\_23", "SG\\_28", "GULD\\_03", "GULD\\_04", "SG\\_23", "SG\\_28")
nprof <- c(12, 10, 7, 8, 15, 11, 9, 10)
minYears <- c(2000, 2000, 2008, 2008, 2000, 2000, 2007, 2007)
maxYears <- c(2018, 2018, 2017, 2018, 2018, 2018, 2018, 2018)

header2 <- c("Season", "Station", "Number of CTD Profiles", "Min", "Max")

ctable2 <- tibble(seasons, stations, nprof, minYears, maxYears)

colnames(ctable2) <- header2

csasdown::csas_table(ctable2,
                     font_size = 12,
                     format = "latex",
                     align = c("l","l","c","c","c"),
                     caption = "Number of CTD profiles collected in spring and fall at each of the four AZMP fixed stations in the Gully MPA. The range in year of collection is also shown for each station and season.") %>% 
  kableExtra::add_header_above(c(" ", " ", " ", "Year" = 2), bold = TRUE)
  # kableExtra::collapse_rows(columns = 1)


```

\clearpage


\begin{landscapepage}

```{r table3, results="asis", include=TRUE, echo=FALSE}

stations <- c(rep("GULD\\_03", 11), rep("SG\\_28", 13), rep("SG\\_23", 13), rep("GULD\\_04", 14))
approxDepth <- c(rep("$\\sim$445 m", 11), rep("$\\sim$804 m", 13), rep("$\\sim$1102 m", 13), rep("$\\sim$1914 m", 14))
nominalDepth <- c(c("BTM", "250", "100", "80", "60", "50", "40", "30", "20", "10", "1"), rep(c("BTM", "750", "500", "250", "100", "80", "60", "50", "40", "30", "20", "10", "1"), 2), c("BTM", "1500", "750", "500", "250", "100", "80", "60", "50", "40", "30", "20", "10", "1"))

# Get the number of rows in the table.
nx <- length(nominalDepth)

# Coerce the nominalDepth array to numeric so it is easier to find the indices 
# for the depths where the different parameters were sampled.
ndepth <- as.numeric(nominalDepth)

# Create arrays for the parameter columns to indicate where samples were taken
chl <- rep("", nx)
ix1 <- which(ndepth <= 100)
chl[ix1] <- "XX"
nuts <- rep("XX", nx)
sal <- rep("", nx)
ix2 <- which((nominalDepth == "BTM") | (nominalDepth == "250") | (nominalDepth == "10"))
sal[ix2] <- "XX"
oxy <- sal
pco2 <- rep("", nx)
ix3 <- which(nominalDepth == "BTM")
pco2[ix3] <- "XX"
ix4 <- stations == "GULD\\_04"
ix5 <- which(stations == "GULD\\_04")
g4nd <- nominalDepth[ix4]
ix6 <- which((g4nd == "1500") | (g4nd == "500") | (g4nd == "100") | (g4nd == "10") | (g4nd == "1"))
pco2[ix5[ix6]] <- "XX"
tic <- pco2
poc <- rep("", nx)
ix7 <- which(nominalDepth == "1")
poc[ix7] <- "XX"
hplc <- poc
abs <- poc
cyto <- poc

# Create the table header
header3 <- c("Station", "Station Depth", "Nominal Depth", "CHL", "NUTS", "SAL", "O~2~", "pCO~2~", "TIC/TA", "POC", "HPLC", "ABS", "CYTO")

# Create the table
ctable3 <- tibble(stations, approxDepth, nominalDepth, chl, nuts, sal, oxy, pco2, tic, poc, hplc, abs, cyto)

colnames(ctable3) <- header3

csasdown::csas_table(ctable3,
                     font_size = 12,
                     format = "latex",
                     align = rep("c", 12),
                     caption = "Summary of nominal depths of water sample collection and variables measured on the four AZMP fixed stations in the Gully MPA. Stations are organized from shallowest to deepest and include the approximate maximum depth based on station bathymetry extracted from GEBCO (2019). The ‘X’ and ‘XX’ indicate the nominal depth at which single (‘X’) and duplicate (‘XX’) samples are collected. ‘BTM’ indicates ‘near-bottom’. CHL = chlorophyll, NUTS = nutrients, SAL = salinity, O2 = dissolved oxygen, pCO2 =  partial pressure of CO2, TIC/TA = Total Inorganic Carbon and Total Alkalinity, POC = particulate organic carbon, HPLC = high performance liquid chromatography, ABS = phytoplankton absorption, and CYTO = flow cytometry for microbial plankton. \"$\\sim$\" represents approximately.")
  # kableExtra::collapse_rows(columns = 1:2)

```

\end{landscapepage}

\clearpage
